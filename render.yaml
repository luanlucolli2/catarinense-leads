# ./render.yaml (ESTRUTURA CORRIGIDA)

# O campo 'services' define suas aplicações (frontend, backend, worker)
services:
  # 1. Serviço para o Frontend (React/Vite)
  - type: web
    name: frontend
    runtime: static
    buildFilter:
      paths:
        - lead-import-visualizer/**
    buildCommand: |
      cd lead-import-visualizer &&
      npm install &&
      npm run build
    staticPublishPath: ./lead-import-visualizer/dist
    routes:
      - type: rewrite
        source: /*
        destination: /index.html

  # 2. Serviço para a API (Backend Laravel)
  - type: web
    name: backend
    runtime: docker
    dockerContext: ./backend
    dockerfilePath: ./backend/Dockerfile.prod
    buildFilter:
      paths:
        - backend/**
    healthCheckPath: /api/health
    envVars:
      - key: APP_URL
        fromService:
          type: web
          name: backend
          property: url
      - key: FRONTEND_URL
        fromService:
          type: web
          name: frontend
          property: url
      - key: DB_CONNECTION
        # Driver do Laravel para PostgreSQL
        value: pgsql
      # CORREÇÃO: Usamos 'fromDatabase' para referenciar o banco de dados
      - key: DATABASE_URL
        fromDatabase:
          name: database
          property: connectionString
      - fromGroup: laravel-secrets
    startCommand: |
      php artisan migrate --force &&
      php artisan config:cache &&
      php artisan route:cache &&
      /usr/sbin/php-fpm83 -O

  # 3. Serviço de Worker para Filas do Laravel
  - type: worker
    name: queue-worker
    runtime: docker
    dockerContext: ./backend
    dockerfilePath: ./backend/Dockerfile.prod
    buildFilter:
      paths:
        - backend/**
    startCommand: "php artisan queue:work --verbose --tries=3 --timeout=120"
    envVars:
      # O worker também precisa da URL do banco para se conectar
      - key: DATABASE_URL
        fromDatabase:
          name: database
          property: connectionString
      - fromGroup: laravel-secrets

# CORREÇÃO: Bancos de dados têm sua própria seção de nível superior
databases:
  - name: database
    # O Render infere que é PostgreSQL. Não é necessário 'type'.
    plan: free

# --- GRUPO DE SEGREDOS ---
envVarGroups:
  - name: laravel-secrets
    envVars:
      - key: APP_KEY
        sync: false
      - key: APP_ENV
        value: production
      - key: APP_DEBUG
        value: false
      - key: SANCTUM_STATEFUL_DOMAINS
        fromService:
          type: web
          name: frontend
          property: url